{% extends "layout.html" %}
{% block content %}
<div class="dashboard">
  <div class="dashboard-header">
    <h2>Welcome, {{ user.first_name }}!</h2>
  </div>
  
  <div class="dashboard-grid">
    <div class="card stats-card">
      <h3>Your Stats</h3>
      <div class="stats">
        <div class="stat">
          <span class="stat-label">ELO Rating</span>
          <span class="stat-value">{{ user.elo_rating }}</span>
        </div>
        <div class="stat">
          <span class="stat-label">Rank</span>
          <span class="stat-value">#{{ user_rank }}</span>
        </div>
        <div class="stat">
          <span class="stat-label">Wins</span>
          <span class="stat-value">{{ user.get_win_count() }}</span>
        </div>
        <div class="stat">
          <span class="stat-label">Losses</span>
          <span class="stat-value">{{ user.get_loss_count() }}</span>
        </div>
        <div class="stat">
          <span class="stat-label">Win Rate</span>
          <span class="stat-value">{{ user.get_win_rate() }}%</span>
        </div>
      </div>
    </div>
    
    <div class="card">
      <h3>Quick Actions</h3>
      <div class="quick-actions">
        <a href="{{ url_for('report_game') }}" class="btn btn-primary">Report Game Result</a>
        <a href="{{ url_for('game_history') }}" class="btn btn-secondary">View Full Game History</a>
        <a href="{{ url_for('tournaments') }}" class="btn btn-secondary">View Tournaments</a>
        <a href="{{ url_for('leaderboard') }}" class="btn btn-secondary">Full Leaderboard</a>
      </div>
    </div>
  </div>
  
  <div class="dashboard-grid">
    <div class="card">
      <h3>Top 10 Leaderboard</h3>
      <table class="leaderboard-table">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Player</th>
            <th>ELO</th>
          </tr>
        </thead>
        <tbody>
          {% for u in leaderboard %}
          <tr {% if u.netid == user.netid %}class="highlight"{% endif %}>
            <td>{{ loop.index }}</td>
            <td>
              {% if u.first_name and u.last_name %}
                {{ u.full_name }}
              {% else %}
                <span class="incomplete-name">Incomplete Profile</span>
              {% endif %}
            </td>
            <td>{{ u.elo_rating }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="margin-bottom: 0;">Recent Games (Last 10)</h3>
        <a href="{{ url_for('game_history') }}" style="font-size: 14px;">View All ‚Üí</a>
      </div>
      {% if recent_games %}
      <div class="games-list">
        {% for game in recent_games %}
        {% set time_diff = (now() - game.timestamp).total_seconds() %}
        {% set can_delete = not game.tournament_id and time_diff < 900 %}
        <div class="game-item">
          <span class="game-type-badge-small {{ game.game_type }}">{{ game.game_type[0].upper() }}</span>
          <div class="game-players">
            {% if game.is_doubles() %}
              <!-- Doubles Game -->
              {% set player3 = User.query.get(game.player3_netid) %}
              {% set player4 = User.query.get(game.player4_netid) %}
              <div class="doubles-teams">
                <span class="team-label {% if game.winner_netid in game.get_team1_netids() %}winner{% endif %}">
                  {{ game.player1.full_name if game.player1 else 'Unknown' }} & {{ game.player2.full_name if game.player2 else 'Unknown' }}
                </span>
                <span class="vs-text">vs</span>
                <span class="team-label {% if game.winner_netid in game.get_team2_netids() %}winner{% endif %}">
                  {{ player3.full_name if player3 else 'Unknown' }} & {{ player4.full_name if player4 else 'Unknown' }}
                </span>
              </div>
            {% else %}
              <!-- Singles Game -->
              <span {% if game.winner_netid == game.player1_netid %}class="winner"{% endif %}>
                {{ game.player1.full_name }}
              </span>
              <span class="vs-text">vs</span>
              <span {% if game.winner_netid == game.player2_netid %}class="winner"{% endif %}>
                {{ game.player2.full_name }}
              </span>
            {% endif %}
          </div>
          <div class="game-meta">
            <span class="elo-change">¬±{{ game.elo_change }}</span>
            <span class="game-time">{{ game.timestamp.strftime('%m/%d %I:%M%p') }}</span>
            {% if can_delete %}
              <form method="POST" action="{{ url_for('delete_game', game_id=game.id) }}" class="delete-form-inline" onsubmit="return confirmDelete()">
                <button type="submit" class="btn-delete-small" title="Delete this game">
                  üóëÔ∏è
                </button>
              </form>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <p>No games yet. <a href="{{ url_for('report_game') }}">Report your first game!</a></p>
      {% endif %}
    </div>
  </div>
  
  {% if open_tournaments or user_tournaments %}
  <div class="card">
    <h3>Tournaments</h3>
    {% if user_tournaments %}
    <h4>Your Active Tournaments</h4>
    <ul class="tournament-list">
      {% for t in user_tournaments %}
      <li>
        <a href="{{ url_for('tournament_detail', tournament_id=t.id) }}">{{ t.name }}</a>
        <span class="tournament-status status-{{ t.status }}">{{ t.status }}</span>
      </li>
      {% endfor %}
    </ul>
    {% endif %}
    
    {% if open_tournaments %}
    <h4>Open for Signup</h4>
    <ul class="tournament-list">
      {% for t in open_tournaments %}
      <li>
        <a href="{{ url_for('tournament_detail', tournament_id=t.id) }}">{{ t.name }}</a>
        <span class="tournament-format">{{ t.format.replace('_', ' ').title() }}</span>
        <span class="tournament-participants">{{ t.get_participant_count() }} players</span>
      </li>
      {% endfor %}
    </ul>
    {% endif %}
  </div>
  {% endif %}
</div>

<style>
.delete-form-inline {
  display: inline-block;
  margin: 0;
  margin-left: 8px;
}
.btn-delete-small {
  background-color: #dc3545;
  color: white;
  border: none;
  padding: 2px 6px;
  border-radius: 3px;
  cursor: pointer;
  font-size: 0.85em;
  transition: background-color 0.2s;
  line-height: 1;
}
.btn-delete-small:hover {
  background-color: #c82333;
}
.game-meta {
  display: flex;
  align-items: center;
  gap: 8px;
}
</style>

<script>
function confirmDelete() {
  return confirm('Are you sure you want to delete this game? This will reverse the ELO changes for all players.');
}
</script>
{% endblock %}
