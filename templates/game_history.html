{% extends "layout.html" %}
{% block title %}Game History - Charter Pool{% endblock %}
{% block content %}
<div class="page-container">
  <h2>Game History</h2>
  
  {% if games %}
  <table class="games-table">
    <thead>
      <tr>
        <th>Date/Time</th>
        <th>Type</th>
        <th>Teams/Players</th>
        <th>Winner</th>
        <th>ELO Change</th>
        <th>Tournament</th>
        {% if not current_user.is_admin %}
        <th>Actions</th>
        {% endif %}
      </tr>
    </thead>
    <tbody>
      {% for game in games %}
      {% set time_diff = (now() - game.timestamp).total_seconds() %}
      {% set can_delete = not current_user.is_admin and not game.tournament_id and time_diff < 900 %}
      <tr>
        <td>{{ game.timestamp.strftime('%Y-%m-%d %I:%M%p') }}</td>
        <td>
          <span class="game-type-badge {{ game.game_type }}">
            {{ game.game_type.title() }}
          </span>
        </td>
        <td>
          {% if game.is_doubles() %}
            <!-- Doubles Game -->
            {% set player3 = User.query.get(game.player3_netid) %}
            {% set player4 = User.query.get(game.player4_netid) %}
            <div class="doubles-match">
              <div class="team {% if game.winner_netid in game.get_team1_netids() %}winning-team{% endif %}">
                <strong>Team 1:</strong> 
                {{ game.player1.full_name if game.player1 else 'Unknown' }} & {{ game.player2.full_name if game.player2 else 'Unknown' }}
              </div>
              <div class="vs-separator">vs</div>
              <div class="team {% if game.winner_netid in game.get_team2_netids() %}winning-team{% endif %}">
                <strong>Team 2:</strong> 
                {{ player3.full_name if player3 else 'Unknown' }} & {{ player4.full_name if player4 else 'Unknown' }}
              </div>
            </div>
          {% else %}
            <!-- Singles Game -->
            <div class="singles-match">
              <span {% if game.player1_netid == game.winner_netid %}class="winner-name"{% endif %}>
                {{ game.player1.full_name }}
              </span>
              <span class="vs-separator">vs</span>
              <span {% if game.player2_netid == game.winner_netid %}class="winner-name"{% endif %}>
                {{ game.player2.full_name }}
              </span>
            </div>
          {% endif %}
        </td>
        <td>
          {% if game.is_doubles() %}
            {% if game.winner_netid in game.get_team1_netids() %}
              Team 1
            {% else %}
              Team 2
            {% endif %}
          {% else %}
            {% set winner = User.query.get(game.winner_netid) %}
            {{ winner.full_name if winner else 'Unknown' }}
          {% endif %}
        </td>
        <td class="elo-cell">¬±{{ game.elo_change }}</td>
        <td>
          {% if game.tournament %}
          <a href="{{ url_for('tournament_detail', tournament_id=game.tournament_id) }}">
            {{ game.tournament.name }}
          </a>
          {% else %}
          <span class="casual-game">Casual</span>
          {% endif %}
        </td>
        {% if not current_user.is_admin %}
        <td>
          {% if can_delete %}
            <form method="POST" action="{{ url_for('delete_game', game_id=game.id) }}" class="delete-form" onsubmit="return confirmDelete()">
              <button type="submit" class="btn-delete" title="Delete this game (within 15 min)">
                üóëÔ∏è Delete
              </button>
            </form>
          {% else %}
            <span class="cannot-delete" title="{% if game.tournament_id %}Tournament games cannot be deleted{% else %}Only games within 15 minutes can be deleted{% endif %}">‚Äî</span>
          {% endif %}
        </td>
        {% endif %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p>No games recorded yet.</p>
  {% endif %}
</div>

<style>
.game-type-badge {
  display: inline-block;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.85em;
  font-weight: 600;
}
.game-type-badge.singles {
  background-color: #3498db;
  color: white;
}
.game-type-badge.doubles {
  background-color: #e67e22;
  color: white;
}
.doubles-match {
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.singles-match {
  display: flex;
  align-items: center;
  gap: 8px;
}
.team {
  padding: 4px 8px;
  border-radius: 4px;
  background-color: #f8f9fa;
}
.winning-team {
  background-color: #d4edda;
  font-weight: 600;
}
.winner-name {
  font-weight: 600;
  color: #28a745;
}
.vs-separator {
  color: #6c757d;
  font-size: 0.9em;
  font-style: italic;
}
.delete-form {
  display: inline-block;
  margin: 0;
}
.btn-delete {
  background-color: #dc3545;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.85em;
  transition: background-color 0.2s;
}
.btn-delete:hover {
  background-color: #c82333;
}
.cannot-delete {
  color: #6c757d;
  font-size: 0.9em;
}
</style>

<script>
function confirmDelete() {
  return confirm('Are you sure you want to delete this game? This will reverse the ELO changes for all players.');
}
</script>
{% endblock %}

