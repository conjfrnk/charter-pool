{% extends "layout.html" %}
{% block title %}Game History - Charter Pool{% endblock %}
{% block content %}
<div class="page-container">
  <h2>Game History</h2>
  <div class="help-text" style="margin-bottom: 12px;">Showing page {{ page }} of {{ total_pages }} ({{ total_games }} games)</div>
  
  {% if games %}
  
  <!-- Mobile Card Layout -->
  <div class="table-cards">
    {% for game in games %}
    {% set time_diff = (now() - game.timestamp).total_seconds() %}
    {% set can_delete = not current_user.is_admin and not game.tournament_id and time_diff < 900 %}
    <div class="game-history-card">
      <div class="game-card-header">
        <span class="game-type-badge {{ game.game_type }}">
          {{ game.game_type.title() }}
        </span>
        <span class="game-card-time">{{ game.timestamp.strftime('%m/%d %I:%M%p') }}</span>
      </div>
      
      <div class="game-card-players">
        {% if game.is_doubles() %}
          {% set player3 = game.player3 %}
          {% set player4 = game.player4 %}
          <div class="team {% if game.winner_netid in game.get_team1_netids() %}winning-team{% endif %}">
            <div class="team-icon">üë•</div>
            <div class="team-names">
              {{ game.player1.full_name if game.player1 else 'Unknown' }} & 
              {{ game.player2.full_name if game.player2 else 'Unknown' }}
            </div>
          </div>
          <div class="vs-divider">VS</div>
          <div class="team {% if game.winner_netid in game.get_team2_netids() %}winning-team{% endif %}">
            <div class="team-icon">üë•</div>
            <div class="team-names">
              {{ player3.full_name if player3 else 'Unknown' }} & 
              {{ player4.full_name if player4 else 'Unknown' }}
            </div>
          </div>
        {% else %}
          <div class="player-name {% if game.winner_netid == game.player1_netid %}winner{% endif %}">
            {{ game.player1.full_name }}
          </div>
          <div class="vs-divider">VS</div>
          <div class="player-name {% if game.winner_netid == game.player2_netid %}winner{% endif %}">
            {{ game.player2.full_name }}
          </div>
        {% endif %}
      </div>
      
      <div class="game-card-footer">
        <div class="game-card-meta">
          <span class="elo-badge">¬±{{ game.elo_change }}</span>
          {% if game.tournament %}
            <span class="tournament-badge">
              <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
              </svg>
              {{ game.tournament.name }}
            </span>
          {% else %}
            <span class="casual-badge">Casual</span>
          {% endif %}
        </div>
        {% if can_delete %}
          <form method="POST" action="{{ url_for('delete_game', game_id=game.id) }}" class="delete-form-inline" onsubmit="return confirmDelete()">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn-delete-card" title="Delete this game">
              <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
              </svg>
            </button>
          </form>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
  
  <!-- Desktop Table Layout -->
  <div class="table-container">
    <table class="games-table">
    <thead>
      <tr>
        <th>Date/Time</th>
        <th>Type</th>
        <th>Teams/Players</th>
        <th>Winner</th>
        <th>ELO Change</th>
        <th>Tournament</th>
        {% if not current_user.is_admin %}
        <th>Actions</th>
        {% endif %}
      </tr>
    </thead>
    <tbody>
      {% for game in games %}
      {% set time_diff = (now() - game.timestamp).total_seconds() %}
      {% set can_delete = not current_user.is_admin and not game.tournament_id and time_diff < 900 %}
      <tr>
        <td>{{ game.timestamp.strftime('%Y-%m-%d %I:%M%p') }}</td>
        <td>
          <span class="game-type-badge {{ game.game_type }}">
            {{ game.game_type.title() }}
          </span>
        </td>
        <td>
          {% if game.is_doubles() %}
            <!-- Doubles Game -->
            {% set player3 = game.player3 %}
            {% set player4 = game.player4 %}
            <div class="doubles-match">
              <div class="team {% if game.winner_netid in game.get_team1_netids() %}winning-team{% endif %}">
                <strong>Team 1:</strong> 
                {{ game.player1.full_name if game.player1 else 'Unknown' }} & {{ game.player2.full_name if game.player2 else 'Unknown' }}
              </div>
              <div class="vs-separator">vs</div>
              <div class="team {% if game.winner_netid in game.get_team2_netids() %}winning-team{% endif %}">
                <strong>Team 2:</strong> 
                {{ player3.full_name if player3 else 'Unknown' }} & {{ player4.full_name if player4 else 'Unknown' }}
              </div>
            </div>
          {% else %}
            <!-- Singles Game -->
            <div class="singles-match">
              <span {% if game.player1_netid == game.winner_netid %}class="winner-name"{% endif %}>
                {{ game.player1.full_name }}
              </span>
              <span class="vs-separator">vs</span>
              <span {% if game.player2_netid == game.winner_netid %}class="winner-name"{% endif %}>
                {{ game.player2.full_name }}
              </span>
            </div>
          {% endif %}
        </td>
        <td>
          {% if game.is_doubles() %}
            {% if game.winner_netid in game.get_team1_netids() %}
              Team 1
            {% else %}
              Team 2
            {% endif %}
          {% else %}
            {% if game.winner_netid == game.player1_netid %}
              {{ game.player1.full_name if game.player1 else 'Unknown' }}
            {% else %}
              {{ game.player2.full_name if game.player2 else 'Unknown' }}
            {% endif %}
          {% endif %}
        </td>
        <td class="elo-cell">¬±{{ game.elo_change }}</td>
        <td>
          {% if game.tournament %}
          <a href="{{ url_for('tournament_detail', tournament_id=game.tournament_id) }}">
            {{ game.tournament.name }}
          </a>
          {% else %}
          <span class="casual-game">Casual</span>
          {% endif %}
        </td>
        {% if not current_user.is_admin %}
        <td>
          {% if can_delete %}
            <form method="POST" action="{{ url_for('delete_game', game_id=game.id) }}" class="delete-form" onsubmit="return confirmDelete()">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button type="submit" class="btn-delete" title="Delete this game (within 15 min)">
                üóëÔ∏è Delete
              </button>
            </form>
          {% else %}
            <span class="cannot-delete" title="{% if game.tournament_id %}Tournament games cannot be deleted{% else %}Only games within 15 minutes can be deleted{% endif %}">‚Äî</span>
          {% endif %}
        </td>
        {% endif %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
  </div>
  <div class="pagination" style="margin-top: 16px; display: flex; gap: 8px; align-items: center;">
    {% if page > 1 %}
      <a class="btn btn-secondary btn-sm" href="{{ url_for('game_history', page=page-1, per_page=request.args.get('per_page', 50)) }}">‚Üê Prev</a>
    {% else %}
      <span class="btn btn-secondary btn-sm" style="opacity:0.6; pointer-events:none;">‚Üê Prev</span>
    {% endif %}
    <span>Page {{ page }} / {{ total_pages }}</span>
    {% if page < total_pages %}
      <a class="btn btn-secondary btn-sm" href="{{ url_for('game_history', page=page+1, per_page=request.args.get('per_page', 50)) }}">Next ‚Üí</a>
    {% else %}
      <span class="btn btn-secondary btn-sm" style="opacity:0.6; pointer-events:none;">Next ‚Üí</span>
    {% endif %}
  </div>
  {% else %}
  <p>No games recorded yet.</p>
  {% endif %}
</div>

<script>
function confirmDelete() {
  return confirm('Are you sure you want to delete this game? This will reverse the ELO changes for all players.');
}
</script>
{% endblock %}

